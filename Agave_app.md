##Registering an App

To write and register an App I suggest reading <a href=https://github.com/cyverseuk/cyverseuk-util/blob/master/app_tutorial/agaveapps.md>this tutorial</a>.  
Note that it's not possible to register an App if there is already one with the same name. You can delete the previous one (if there was an error), or change the version number (if you need to make an updated version).  

Also, it's not possible (of course) to run an App in Cyverse interactively. To run multiple commands in a Docker container we need the following syntax:  
```
docker run <image_name[:tag]> /bin/bash -c "command1;command2...;".
```  
`/bin/bash` is not strictly necessary, but, depending on the base image, bash may not be the default shell: adding it to command line takes care of this problem.  

**IMPORTANT UPDATE**: in Docker version 1.12 the `SHELL` instruction was added. This allows the default shell used for the shell form of commands to be overridden (at build time too). Use it as follows:  
`SHELL ["/bin/bash", "-c"]`

The HPC is using HTCondor, so the JSON file alone is not enough to run the app: a `wrapper.sh` script (to handle the variables and determine the actual command to be run) and a `HTCondorSubmit.htc` script are needed. The wrapper script has to perform all the checks that the Agave API doesn't support (mutually inclusive or exclusive parameters for example). It may be useful to use the wrapper script to delete any new files that is not needed from the working directory, to avoid it to be transferred back to the DE.  
The HTCondorSubmit.htc file will be in the following form:
```
universe                = docker
docker_image            = <image_name>[:tag]
executable              = <command>
should_transfer_files   = YES
arguments               = <arguments_for_executable>
transfer_input_files    = <files to transfer separated by commas>
transfer_output_files   = <files/folder to transfer separated by commas>
when_to_transfer_output = ON_EXIT
request_memory          = 100G
```  
`transfer_output_files` is not needed if the output are in the working directory. Of course this HTCondor submit is generated by the wrapper.sh since we can't know in advance arguments and inputs files.  
If transferring executables, make sure to restore the right permissions in the script (e.g `chmod u+x <file_name>`).  
It's also possible that the Docker image has to be updated giving 777 permissions to scripts because of how condor handle docker.  

A good idea is to create, when possible, all the output files in a subdirectory (e.g. `output`) of the working directory, so that the transfer is easier.  

The App, after being made public with (this step has to be performed by a tenant admin)  
```
apps-pems-update -v -u <username> -p ALL <app_name>-<version>
```  
can be found in the <a href=https://de.iplantcollaborative.org/de/>DE</a>, under Apps>High-Performance Computing. The App interface is automatically generated based on the submitted JSON file.

#####Additional notes on the JSON file

Following the introductory part the JSON file lists inputs and parameters. A good documentation about the available fields and their usage can be found <a href=http://agaveapi.co/documentation/tutorials/app-management-tutorial/app-inputs-and-parameters-tutorial/>here</a>.  
For the application (if you wish to publish it) to display a proper information window in the Discovery Environment, the following fields need to be present in the JSON file: `help_URI`, `datePublished`, `author`, `longDescription`.  
In the `ontology` field a list of IRI for topic and operation branches of the <a href=http://www.ebi.ac.uk/ols/ontologies/edam>EDAM ontology</a> has to be specified to properly categorize the App.  
If `details.showArgument` (boolean) is set to `true`, it will pass `details.argument` before the value (e.g. if we want to pass to command line `--kmer 31`). Note that the argument is put before the value without spaces (so usually we want to add one in the string)!!  
`value.validator` can supply a check on the format of the submitted value as a <a href=http://perldoc.perl.org/perlre.html>perl formatted regular expression</a>. (**pay particular attention to the escapes**) Example case: JSON `value.type` doesn't provide a distinction between integers and floating point, but just `number`. To check the input is an integer we may use `"validator": "^\\d*$"` (or `"^[0-9]+$"` to avoid the escapes). The same field also allow to accept just even/odd numbers, set a maximum value, etc.  
We usually don't want the user to work in a folder that is not the set working directory, so if the program run by the App has a `--output_directory` option (or similar) we may want to add a validator to be sure that the string doesn't start with '/', or just hide it and give a default name (e.g. `ouput`).

**IMPORTANT**:  
```json
"value": {
    ...
    "visible": false,
    "default": "default_value",
    ...
}
```  
is NOT supported. The default value must be provided in the wrapper script if we don't want the user to be able to change it.  

###Running an App

Again see a full tutorial <a href=https://github.com/cyverseuk/cyverseuk-util/blob/master/app_tutorial/agaveapps.md>here</a>.

<hr/>

